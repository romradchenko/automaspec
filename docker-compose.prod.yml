services:
    app:
        image: automaspec:prod-${VERSION:-latest}
        build:
            context: .
            target: runner
            tags:
                - automaspec:prod-${VERSION:-latest}
        ports:
            - '${PORT:-3000}:${PORT:-3000}'
        environment:
            - PORT=${PORT:-3000}
            - NODE_ENV=production
        env_file:
            - .env
        networks:
            - automaspec-network
        restart: always
        healthcheck:
            test: ['CMD-SHELL', 'curl -f http://localhost:$$PORT/ || exit 1']
            interval: 30s
            timeout: 3s
            start_period: 40s
            retries: 3
        deploy:
            resources:
                limits:
                    cpus: '2'
                    memory: 2G
                reservations:
                    cpus: '1'
                    memory: 1.5G

networks:
    automaspec-network:
        driver: bridge
